/**
 @Title: layui.upload 文件上传
 @Author: 贤心
 @License：MIT
 */
layui.define("layer",function(n){"use strict";var t=layui.$,c=layui.layer,l=layui.hint(),r=layui.device(),e={config:{},set:function(n){var i=this;return i.config=t.extend({},i.config,n),i},on:function(n,t){return layui.onevent.call(this,s,n,t)}},a=function(){var n=this;return{upload:function(t){n.upload.call(n,t)},config:n.config}},s="upload",h="layui-upload-file",f="layui-upload-form",u="layui-upload-iframe",o="layui-upload-choose",i=function(n){var i=this;i.config=t.extend({},i.config,e.config,n);i.render()};i.prototype.config={accept:"images",exts:"",auto:!0,bindAction:"",url:"",field:"file",method:"post",data:{},drag:!0,size:0,number:0,multiple:!1};i.prototype.render=function(n){var i=this,n=i.config;n.elem=t(n.elem);n.bindAction=t(n.bindAction);i.file();i.events()};i.prototype.file=function(){var i=this,n=i.config,e=i.elemFile=t(['<input class="'+h+'" type="file" accept="'+n.acceptMime+'" name="'+n.field+'"',n.multiple?" multiple":"",">"].join("")),u=n.elem.next();(u.hasClass(h)||u.hasClass(f))&&u.remove();r.ie&&r.ie<10&&n.elem.wrap('<div class="layui-upload-wrap"><\/div>');i.isFile()?(i.elemFile=n.elem,n.field=n.elem[0].name):n.elem.after(e);r.ie&&r.ie<10&&i.initIE()};i.prototype.initIE=function(){var i=this,n=i.config,r=t('<iframe id="'+u+'" class="'+u+'" name="'+u+'" frameborder="0"><\/iframe>'),e=t(['<form target="'+u+'" class="'+f+'" method="post" key="set-mine" enctype="multipart/form-data" action="'+n.url+'">',"<\/form>"].join(""));t("#"+u)[0]||t("body").append(r);n.elem.next().hasClass(f)||(i.elemFile.wrap(e),n.elem.next("."+f).append(function(){var t=[];return layui.each(n.data,function(n,i){i=typeof i=="function"?i():i;t.push('<input type="hidden" name="'+n+'" value="'+i+'">')}),t.join("")}()))};i.prototype.msg=function(n){return c.msg(n,{icon:2,shift:6})};i.prototype.isFile=function(){var n=this.config.elem[0];if(n)return n.tagName.toLocaleLowerCase()==="input"&&n.type==="file"};i.prototype.preview=function(n){var t=this;window.FileReader&&layui.each(t.chooseFiles,function(t,i){var r=new FileReader;r.readAsDataURL(i);r.onload=function(){n&&n(t,i,this.result)}})};i.prototype.upload=function(n,f){var e=this,s=e.config,h=e.elemFile[0],v=function(){var i=0,r=0,f=n||e.files||e.chooseFiles||h.files,u=function(){s.multiple&&i+r===e.fileLength&&typeof s.allDone=="function"&&s.allDone({total:e.fileLength,successful:i,aborted:r})};layui.each(f,function(n,f){var o=new FormData;o.append(s.field,f);layui.each(s.data,function(n,t){t=typeof t=="function"?t():t;o.append(n,t)});t.ajax({url:s.url,type:"post",data:o,contentType:!1,processData:!1,dataType:"json",headers:s.headers||{},success:function(t){i++;y(n,t);u()},error:function(){r++;e.msg("请求上传接口出现异常");p(n);u()}})})},k=function(){var n=t("#"+u);e.elemFile.parent().submit();clearInterval(i.timer);i.timer=setInterval(function(){var t,r=n.contents().find("body");try{t=r.text()}catch(u){e.msg("获取上传后的响应信息出现异常");clearInterval(i.timer);p()}t&&(clearInterval(i.timer),r.html(""),y(0,t))},30)},y=function(n,t){if(e.elemFile.next("."+o).remove(),h.value="",typeof t!="object")try{t=JSON.parse(t)}catch(i){return t={},e.msg("请对上传接口返回有效JSON")}typeof s.done=="function"&&s.done(t,n||0,function(n){e.upload(n)})},p=function(n){s.auto&&(h.value="");typeof s.error=="function"&&s.error(n||0,function(n){e.upload(n)})},l=s.exts,w,c=function(){var t=[];return layui.each(n||e.chooseFiles,function(n,i){t.push(i.name)}),t}(),b={preview:function(n){e.preview(n)},upload:function(n,t){var i={};i[n]=t;e.upload(i)},pushFile:function(){return e.files=e.files||{},layui.each(e.chooseFiles,function(n,t){e.files[n]=t}),e.files},resetFile:function(n,t,i){var r=new File([t],i);e.files=e.files||{};e.files[n]=r}},d=function(){if(f!=="choose"&&!s.auto||(s.choose&&s.choose(b),f!=="choose")){if(s.before&&s.before(b),r.ie)return r.ie>9?v():k();v()}},a;if(c=c.length===0?h.value.match(/[^\/\\]+\..+/g)||[]||"":c,c.length!==0){switch(s.accept){case"file":if(l&&!RegExp("\\w\\.("+l+")$","i").test(escape(c)))return e.msg("选择的文件中包含不支持的格式"),h.value="";break;case"video":if(!RegExp("\\w\\.("+(l||"avi|mp4|wma|rmvb|rm|flash|3gp|flv")+")$","i").test(escape(c)))return e.msg("选择的视频中包含不支持的格式"),h.value="";break;case"audio":if(!RegExp("\\w\\.("+(l||"mp3|wav|mid")+")$","i").test(escape(c)))return e.msg("选择的音频中包含不支持的格式"),h.value="";break;default:if(layui.each(c,function(n,t){RegExp("\\w\\.("+(l||"jpg|png|gif|bmp|jpeg$")+")","i").test(escape(t))||(w=!0)}),w)return e.msg("选择的图片中包含不支持的格式"),h.value=""}if(e.fileLength=function(){var t=0,i=n||e.files||e.chooseFiles||h.files;return layui.each(i,function(){t++}),t}(),s.number&&e.fileLength>s.number)return e.msg("同时最多只能上传的数量为："+s.number);if(s.size>0&&!(r.ie&&r.ie<10)&&(layui.each(e.chooseFiles,function(n,t){if(t.size>1024*s.size){var i=s.size/1024;i=i>=1?i.toFixed(2)+"MB":s.size+"KB";h.value="";a=i}}),a))return e.msg("文件不能超过"+a);d()}};i.prototype.events=function(){var n=this,i=n.config,u=function(t){n.chooseFiles={};layui.each(t,function(t,i){var r=(new Date).getTime();n.chooseFiles[r+"-"+t]=i})},f=function(t){var r=n.elemFile,u=t.length>1?t.length+"个文件":(t[0]||{}).name||r[0].value.match(/[^\/\\]+\..+/g)||[]||"";(r.next().hasClass(o)&&r.next().remove(),n.upload(null,"choose"),n.isFile()||i.choose)||r.after('<span class="layui-inline '+o+'">'+u+"<\/span>")};i.elem.off("upload.start").on("upload.start",function(){var u=t(this),r=u.attr("lay-data");if(r)try{r=new Function("return "+r)();n.config=t.extend({},i,r)}catch(f){l.error("Upload element property lay-data configuration item has a syntax error: "+r)}n.config.item=u;n.elemFile[0].click()});if(!(r.ie&&r.ie<10))i.elem.off("upload.over").on("upload.over",function(){var n=t(this);n.attr("lay-over","")}).off("upload.leave").on("upload.leave",function(){var n=t(this);n.removeAttr("lay-over")}).off("upload.drop").on("upload.drop",function(r,e){var s=t(this),o=e.originalEvent.dataTransfer.files||[];s.removeAttr("lay-over");u(o);i.auto?n.upload(o):f(o)});n.elemFile.off("upload.change").on("upload.change",function(){var t=this.files||[];u(t);i.auto?n.upload():f(t)});i.bindAction.off("upload.action").on("upload.action",function(){n.upload()});if(!i.elem.data("haveEvents")){n.elemFile.on("change",function(){t(this).trigger("upload.change")});i.elem.on("click",function(){n.isFile()||t(this).trigger("upload.start")});if(i.drag)i.elem.on("dragover",function(n){n.preventDefault();t(this).trigger("upload.over")}).on("dragleave",function(){t(this).trigger("upload.leave")}).on("drop",function(n){n.preventDefault();t(this).trigger("upload.drop",n)});i.bindAction.on("click",function(){t(this).trigger("upload.action")});i.elem.data("haveEvents",!0)}};e.render=function(n){var t=new i(n);return a.call(t)};n(s,e)});